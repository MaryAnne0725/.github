# Making R packages

<aside>
ðŸ’¡ This page is based on the blog: [https://tinyheero.github.io/jekyll/update/2015/07/26/making-your-first-R-package.html](https://tinyheero.github.io/jekyll/update/2015/07/26/making-your-first-R-package.html)

</aside>

## 0. Install **package creator and documentation tools**

```r
install.packages**(**"devtools"**)
install.packages("roxygen2")**
```

## 1. Create a package

- A package name `regkurs` is the **created** with the command

```r
devtools::create("regkurs")
```

- The create command sets up a **folder structure** for the package:
    - **DESCRIPTION**: This is where all the meta-data about your package goes.
    - **regkurs.Rproj**: This is a RStudio specific file that treats the package as project in RStudio. Can be convenient. Just click on the file in your file explorer and the whole project for the package will be loaded in Rstudio.
    - **R**: This is where all your R code goes for your package. Your source files (.R) with all the functions in the package should be placed here.
    - the **man** folder will contain the documentation, when that is created. This folder will not be available at this stage. See below on creating documentation.
    - the **vignette** folder with the tutorials for the package, if and when such are created.
    - the **data** folder will contain the datasets included in the package, when datasets have been added. This folder will not be available at this stage. See below on adding data.

## 2. Adding files to the package

- Add source files (.R) to the /R folder. Set the working directory using for example `setwd()` to the folder of the generated package. The following command will build the package and install it on your local machine in the R system library:
    
    ```r
    devtools::install()
    ```
    
    - The **basic workflow** after a package has been initialized:
    - `devtools::document()` builds the documentation files on your local machine.
    - `devtools::install()`
- **Including datasets in the package**. Doing  `devtools::use_data(mydata)` makes the dataset in `mydata` available in the package as the file `/data/mydata.rda`
UPDATE: I had to do the following for this to work (on Linux at least):
    
    ```r
    library(devtools)
    use_data(mydata)
    ```
    
- **Using other packages in your package.** *Never use library()* in your package. Instead to this:
    - Add the following in your DESCRIPTION file (tells the package that it depends on these two packages. In the example below, the first package needs to be version 1.9.4 or higher, the other the most recent version):
    
    ```r
    Imports:
    	data.table (>= 1.9.4),
    	dplyr
    ```
    
    - use the double-colon `::` when using functions from other packages from within your package. For example `dplyr::filter()` to use the `filter` function from the `dplyr` package.

## 3. Documenting packages

Functions and datasets in the package can be documented so that users can get help within R with the usual `?` . 

- The documentation of a function should be placed right above the function definition for the system to find it when building the docs. Here is an example:

```r
#' Summarize the results from a logistic regression analysis
#'
#' Alternative to `summary.glm` to summarize a regression from `glm`.
#' Prints a table similar to the one generated by SAS and Minitab.
#' @param glmobject a fitted regression model from `glm`.
#' @param param `TRUE` if parameter estimates, standard errors etc is computed.
#' @param conf_intervals `TRUE` if confidence intervals for parameters.
#' @param vif_factors `TRUE` if variance inflation factors are to be printed.
#' @return list with two tables: param, odds_ratio
#' @export
#' @examples
#' library(regkurs)
#' glmfit <- glm(survived ~ age + sex + firstclass, data = titanic, family = binomial)
#' logisticregsummary(glmfit)
```

![logisticregsummary.png](Making%20R%20p%20907c8/logisticregsummary.png)

The `@export` makes sure that this function is included in the docs.

- To **build the documentation**, use the command

```r
devtools::document()
```

- **Math in documentation**. The equation $y = \beta_0 + \beta_1x_1+\ldots,\beta_k x_k+\varepsilon$ can be included in the documentation as â€˜display equationâ€™ (use `\eqn{}`  for inline equations):

```r
\deqn{y = \beta_1 x_1 + \ldots + \beta_k x_k + \epsilon}{y = \beta_1 *x_1 + .... + \beta_k x_k + \epsilon}
```

Note that the maths is written twice:

- first in a latex version which prints well in the pdf
- then in a ascii version which prints well inside R

The general syntax for maths in the docs is hence  `\deqn{latex}{ascii}`. It is ok to just use `\deqn{ascii}`, but that will not give you latex in the pdf file of the docs.

- A **dataset** can be **documented** by editing adding an entry in the files in `/R/datasets.R` (you have to create this file once for the package).  Here is an example:

```r
#' Survival of passengers on the Titanic
#'
#' This data set provides information on the fate of passengers on the fatal maiden voyage of the ocean liner â€˜Titanicâ€™, summarized according to economic status (class), sex, age and survival. \cr \cr
#' NOTE: this is not the same as the dataset Titanic (note capital T) which has more observations, but also missing values.
#'
#' The sinking of the Titanic is a famous event, and new books are still being published about it. Many well-known factsâ€”from the proportions of first-class passengers to the â€˜women and children firstâ€™ policy, and the fact that that policy was not entirely successful in saving the women and children in the third classâ€”are reflected in the survival rates for various classes of passenger. \cr
#' These data were originally collected by the British Board of Trade in their investigation of the sinking. Note that there is not complete agreement among primary sources as to the exact numbers on board, rescued, or lost. \cr
#' Due in particular to the very successful film â€˜Titanicâ€™, the last years saw a rise in public interest in the Titanic. Very detailed data about the passengers is now available on the Internet, at sites such as Encyclopedia Titanica (https://www.encyclopedia-titanica.org/).
#'
#' @format A data frame with 887 rows and 8 variables:
#' \describe{
#'   \item{name}{passenger name}
#'   \item{survived}{0 = no, 1 = yes}
#'   \item{sex}{male/female}
#'   \item{age}{age of passenger}
#'   \item{fare}{ticket cost}
#'   \item{firstclass}{first class ticket}
#'   ...
#' }
#' @source Dawson, Robert J. MacG. (1995), The â€˜Unusual Episodeâ€™ Data Revisited. Journal of Statistics Education, 3. doi: 10.1080/10691898.1995.11910499.
"titanic"
```

- The **pdf of the manual** can be build with (may not work on windows)

```r
devtools::build_manual(path = "./man") # Builds the pdf in the /man subfolder
```

- **Vignettes** give a nice tutorial style intro to your package:

```r
usethat**::**use_vignette**(**"introduction"**)**
```

This will create aÂ `vignette/introduction.Rmd`Â file. This is a vignette template Rmarkdown file that you can then use to fill out steps on how you can use your package.

## 4. Making the package available to others

- If you have a mature package, you can [register it on CRAN](https://r-pkgs.org/release.html).
- An easier way to distribute your package is to host it on [GitHub](https://github.com/). See Point 5 below for info.
- **Users can install the package** with the commands:

```r
install.packages("remotes") # install only once to get the install_git() function
library(remotes)
install_git("mattiasvillani/regkurs") # The repository regkurs on my github 'mattiasvillani'
library(regkurs)
```

- Here is the regkurs package on github: https://github.com/mattiasvillani/regkurs

![githubregkurs.png](Making%20R%20p%20907c8/githubregkurs.png)

## 5. Creating a Github repository for the package

- **Make a github account**. It free for unlimited public repositories. But even private repositories are free if you are an academic: [https://docs.github.com/en/education/explore-the-benefits-of-teaching-and-learning-with-github-education/use-github-in-your-classroom-and-research/apply-for-an-educator-or-researcher-discount](https://docs.github.com/en/education/explore-the-benefits-of-teaching-and-learning-with-github-education/use-github-in-your-classroom-and-research/apply-for-an-educator-or-researcher-discount)
- Click the â€˜New repositoryâ€™ button on the top left:

![newrepo.png](Making%20R%20p%20907c8/newrepo.png)

- Fill in the info about the repo. Donâ€™t click the last three boxes if you are importing an existing repository (which is often what you will do).

![repoinit.png](Making%20R%20p%20907c8/repoinit.png)

- The above creates an empty repository at Github. Now it is time to make Git repository on your local computer. In the terminal: go to the directory of your R package and type this code in the terminal (assuming your repo is called `myprettypackage`)

```bash
echo "# myprettypackage" >> README.md
git init
git add README.md
git commit -m "first commit"
git branch -M main
```

You now have a local git repository on your computer (given by the hidden .git folder in your R package directory)!

- The final step is to connect your local repository to the one on Github:

```bash
git remote add origin git@github.com:StatisticsSU/myprettypackage.git
```

- You can now **push** the files in your local repo to the Github repo.

```bash
git push -u origin main
```

- Or you can **push directly from RStudio**

![rstudiogit.png](Making%20R%20p%20907c8/rstudiogit.png)

- You can **pull** someone elses changes in your `myprettypackage`  on Github to your local git repository.